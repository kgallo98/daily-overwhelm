<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Daily Overwhelm</title>

    <!-- PWA setup -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1a2e">
    <!-- iOS specific -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Overwhelm">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        * {
            box-sizing: border-box;
        }

        :root {
            --bg-color: #1a1a2e;
            --card-bg: #16213e;
            --text-color: #eee;
            --text-muted: #aaa;
            --text-light: #bbb;
            --border-color: #333;
            --input-bg: #0f0f23;
            --shadow: rgba(0,0,0,0.3);
            --accent: #4a90a4;
            --done-color: #5cb85c;
            --later-color: #f0ad4e;
        }

        /* Bedtime mode - warmer, softer colors */
        body.bedtime-mode {
            --bg-color: #1a1610;
            --card-bg: #2a2018;
            --text-color: #e8dcc8;
            --text-muted: #a89880;
            --text-light: #c8b8a0;
            --border-color: #3a3028;
            --input-bg: #1a1610;
            --accent: #c4956a;
        }

        body.bedtime-mode #big-mic-button {
            box-shadow: 0 4px 20px rgba(196, 149, 106, 0.3);
        }

        body.bedtime-mode .ripple {
            border-color: var(--accent);
        }

        /* Top buttons */
        #bedtime-toggle, #settings-toggle {
            position: fixed;
            top: 15px;
            background: none;
            border: none;
            font-size: 22px;
            cursor: pointer;
            z-index: 50;
            opacity: 0.6;
            transition: opacity 0.2s;
            padding: 8px;
        }

        #bedtime-toggle { right: 15px; }
        #settings-toggle { left: 15px; }

        #bedtime-toggle:hover, #settings-toggle:hover {
            opacity: 1;
        }

        /* Settings panel */
        #settings-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 200;
            transform: translateX(-100%);
            transition: transform 0.3s ease-out;
            overflow-y: auto;
            padding: 20px;
            padding-top: 60px;
        }

        #settings-panel.visible {
            transform: translateX(0);
        }

        #settings-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
        }

        #settings-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 30px;
            color: var(--text-color);
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 15px;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item-label {
            font-size: 16px;
            color: var(--text-color);
        }

        .settings-item-desc {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: 0.3s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--accent);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        .toggle-switch input:disabled + .toggle-slider {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .settings-coming-soon {
            font-size: 11px;
            color: var(--accent);
            margin-left: 10px;
        }

        /* Hide text input in bedtime mode */
        body.bedtime-mode #text-input-section {
            display: none;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
        }

        /* Tab content */
        .tab-content {
            flex: 1;
            display: none;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .tab-content.active {
            display: flex;
        }

        /* ===== CAPTURE TAB ===== */
        #capture-tab {
            position: relative;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        #mic-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #big-mic-button {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background-color: var(--accent);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 4px 20px rgba(74, 144, 164, 0.4);
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s;
            position: relative;
            z-index: 2;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 15px;
            font-weight: 400;
            letter-spacing: 0.5px;
            text-transform: lowercase;
        }

        #big-mic-button:active {
            transform: scale(0.98);
        }

        #big-mic-button.listening {
            background-color: #e74c3c;
            box-shadow: 0 4px 30px rgba(231, 76, 60, 0.5);
            animation: pulse-listening 1s infinite;
        }

        .ripple {
            position: absolute;
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: 1px solid var(--accent);
            opacity: 0;
            z-index: 1;
            pointer-events: none;
        }

        .ripple-1 { animation: ripple 7s ease-out infinite; }
        .ripple-2 { animation: ripple 7s ease-out infinite 2s; }

        @keyframes ripple {
            0% { transform: scale(1); opacity: 0.4; }
            57% { transform: scale(1.8); opacity: 0; }
            100% { transform: scale(1.8); opacity: 0; }
        }

        @keyframes pulse-listening {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        #mic-container.listening .ripple {
            animation: none;
            opacity: 0;
        }

        #capture-confirmation {
            margin-top: 30px;
            padding: 15px 25px;
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: 12px;
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #capture-confirmation.visible {
            opacity: 1;
        }

        #text-input-section {
            position: absolute;
            bottom: 80px;
            left: 20px;
            right: 20px;
            max-width: 300px;
            margin: 0 auto;
        }

        #thought-input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--text-color);
            text-align: center;
        }

        #thought-input::placeholder {
            color: var(--text-muted);
        }

        /* Swipe hint at bottom of capture tab */
        #capture-swipe-hint {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
            opacity: 0.5;
        }

        /* ===== FOCUS OVERLAY (swipe up from capture) ===== */
        #focus-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 100;
            transform: translateY(100%);
            display: flex;
            flex-direction: column;
            will-change: transform;
        }

        #focus-overlay.animating {
            transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1);
        }

        #focus-overlay.visible {
            transform: translateY(0);
        }

        #focus-handle {
            padding: 15px;
            display: flex;
            justify-content: center;
            cursor: grab;
        }

        #focus-handle:active {
            cursor: grabbing;
        }

        .handle-pill {
            width: 36px;
            height: 4px;
            background-color: var(--text-muted);
            border-radius: 2px;
            opacity: 0.4;
        }

        #focus-cards-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            gap: 10px;
            overflow: hidden;
        }

        #focus-message {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px 20px;
        }

        #focus-message-title {
            font-size: 24px;
            color: var(--text-color);
            margin-bottom: 10px;
        }

        #focus-message-subtitle {
            font-size: 16px;
            color: var(--text-muted);
        }

        /* Focus card wrapper */
        .focus-card-wrapper {
            position: relative;
            flex: 1;
            max-height: 150px;
            border-radius: 12px;
            overflow: hidden;
            transition: flex 0.3s ease-out, opacity 0.3s ease-out, max-height 0.3s ease-out;
        }

        .focus-card-wrapper.removing {
            flex: 0;
            max-height: 0;
            opacity: 0;
            margin: 0;
        }

        /* Swipe backgrounds */
        .swipe-bg {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            display: flex;
            align-items: center;
            padding: 0 20px;
            font-size: 16px;
            font-weight: 500;
            color: white;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .swipe-bg-left {
            background-color: var(--later-color);
            justify-content: flex-end;
        }

        .swipe-bg-right {
            background-color: var(--done-color);
            justify-content: flex-start;
        }

        /* Focus card */
        .focus-card {
            position: relative;
            height: 100%;
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            touch-action: pan-y pinch-zoom;
            transition: transform 0.1s ease-out;
        }

        .focus-card.swiping {
            transition: none;
        }

        .focus-card-text {
            font-size: 16px;
            color: var(--text-color);
            line-height: 1.3;
            flex: 1;
        }

        /* ===== TODAY TAB ===== */
        #today-tab {
            padding-top: 50px;
        }

        .section-title {
            font-size: 14px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            margin-top: 30px;
        }

        .section-title:first-child {
            margin-top: 0;
        }

        .task-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .task-item {
            padding: 15px;
            background-color: var(--card-bg);
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 16px;
            color: var(--text-color);
        }

        .task-item.later {
            border-left: 3px solid var(--later-color);
        }

        .task-item.completed {
            border-left: 3px solid var(--done-color);
            color: var(--text-light);
        }

        .empty-section {
            color: var(--text-muted);
            font-size: 14px;
            padding: 20px;
            text-align: center;
            opacity: 0.6;
        }

        /* ===== ALL TAB ===== */
        #all-tab {
            padding-top: 50px;
        }

        .backlog-item {
            padding: 15px;
            background-color: var(--card-bg);
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .backlog-item-text {
            font-size: 16px;
            color: var(--text-color);
            flex: 1;
        }

        .backlog-item-meta {
            font-size: 12px;
            color: var(--text-muted);
            margin-left: 10px;
        }

        /* ===== TAB BAR ===== */
        #tab-bar {
            display: flex;
            background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
            padding: 8px 0;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
        }

        .tab-button {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 11px;
            padding: 6px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
        }

        .tab-button svg {
            width: 22px;
            height: 22px;
        }

        .tab-button.active {
            color: var(--accent);
        }

        /* Icon button styling */
        #settings-toggle svg,
        #bedtime-toggle svg,
        #settings-close svg {
            display: block;
        }
    </style>
</head>
<body>
    <!-- SETTINGS TOGGLE -->
    <button id="settings-toggle" title="Settings">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
    </button>

    <!-- BEDTIME TOGGLE -->
    <button id="bedtime-toggle" title="Toggle bedtime mode">
        <svg class="icon-moon" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
        <svg class="icon-sun" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
    </button>

    <!-- SETTINGS PANEL -->
    <div id="settings-panel">
        <button id="settings-close">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
        <div id="settings-title">settings</div>

        <div class="settings-section">
            <div class="settings-section-title">Notifications</div>

            <div class="settings-item">
                <div>
                    <div class="settings-item-label">Bedtime reminder<span class="settings-coming-soon">coming soon</span></div>
                    <div class="settings-item-desc">Prompt to capture thoughts before sleep</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-bedtime-notif" disabled>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="settings-item">
                <div>
                    <div class="settings-item-label">Morning focus<span class="settings-coming-soon">coming soon</span></div>
                    <div class="settings-item-desc">Daily reminder of your focus items</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-morning-notif" disabled>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="settings-item">
                <div>
                    <div class="settings-item-label">Periodic reminders<span class="settings-coming-soon">coming soon</span></div>
                    <div class="settings-item-desc">Gentle nudges throughout the day</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-periodic-notif" disabled>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-section-title">Display</div>

            <div class="settings-item">
                <div>
                    <div class="settings-item-label">Daily focus items</div>
                    <div class="settings-item-desc">How many tasks to show each day</div>
                </div>
                <select id="setting-daily-items" style="padding: 8px 12px; font-size: 16px; background: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 8px;">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3" selected>3</option>
                    <option value="5">5</option>
                </select>
            </div>
        </div>
    </div>

    <!-- CAPTURE TAB -->
    <div id="capture-tab" class="tab-content active">
        <div id="mic-container">
            <div class="ripple ripple-1"></div>
            <div class="ripple ripple-2"></div>
            <button id="big-mic-button">tap to capture</button>
        </div>
        <div id="capture-confirmation"></div>
        <div id="text-input-section">
            <input type="text" id="thought-input" placeholder="or type here">
        </div>
        <div id="capture-swipe-hint">swipe up for today's focus</div>
    </div>

    <!-- FOCUS OVERLAY -->
    <div id="focus-overlay">
        <div id="focus-handle">
            <div class="handle-pill"></div>
        </div>
        <div id="focus-cards-container">
            <!-- Cards or message will be rendered here -->
        </div>
    </div>

    <!-- TODAY TAB -->
    <div id="today-tab" class="tab-content">
        <div class="section-title">for later</div>
        <ul id="later-list" class="task-list"></ul>

        <div class="section-title">completed today</div>
        <ul id="completed-today-list" class="task-list"></ul>
    </div>

    <!-- ALL TAB -->
    <div id="all-tab" class="tab-content">
        <div class="section-title">backlog</div>
        <div id="backlog-list"></div>
    </div>

    <!-- TAB BAR -->
    <div id="tab-bar">
        <button class="tab-button active" data-tab="capture-tab">
            <svg class="tab-icon" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="16"></line>
                <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg>
            <span>Capture</span>
        </button>
        <button class="tab-button" data-tab="today-tab">
            <svg class="tab-icon" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <circle cx="12" cy="12" r="6"></circle>
                <circle cx="12" cy="12" r="2"></circle>
            </svg>
            <span>Today</span>
        </button>
        <button class="tab-button" data-tab="all-tab">
            <svg class="tab-icon" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="8" y1="6" x2="21" y2="6"></line>
                <line x1="8" y1="12" x2="21" y2="12"></line>
                <line x1="8" y1="18" x2="21" y2="18"></line>
                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                <line x1="3" y1="18" x2="3.01" y2="18"></line>
            </svg>
            <span>All</span>
        </button>
    </div>

    <script>
        // ===== DATA MODEL =====
        let thoughts = JSON.parse(localStorage.getItem('thoughts')) || [];
        let todayFocus = JSON.parse(localStorage.getItem('todayFocus')) || [];
        let laterToday = JSON.parse(localStorage.getItem('laterToday')) || [];
        let completedToday = JSON.parse(localStorage.getItem('completedToday')) || [];
        let completedAllTime = JSON.parse(localStorage.getItem('completedAllTime')) || [];
        let lastResetDate = localStorage.getItem('lastResetDate') || '';

        // Migrate old format
        thoughts = thoughts.map(item => typeof item === 'string' ? { text: item, skips: 0 } : item);

        function saveAll() {
            localStorage.setItem('thoughts', JSON.stringify(thoughts));
            localStorage.setItem('todayFocus', JSON.stringify(todayFocus));
            localStorage.setItem('laterToday', JSON.stringify(laterToday));
            localStorage.setItem('completedToday', JSON.stringify(completedToday));
            localStorage.setItem('completedAllTime', JSON.stringify(completedAllTime));
            localStorage.setItem('lastResetDate', lastResetDate);
        }

        function getTodayDate() {
            return new Date().toDateString();
        }

        function checkDailyReset() {
            const today = getTodayDate();
            if (lastResetDate !== today) {
                // New day - reset
                laterToday = [];
                completedToday = [];
                lastResetDate = today;
                selectTodayFocus();
                saveAll();
            }
        }

        function selectTodayFocus() {
            const count = parseInt(localStorage.getItem('dailyFocusItems') || '3');
            todayFocus = thoughts.slice(0, count).map(t => ({ ...t }));
        }

        // Initialize on load
        checkDailyReset();
        if (todayFocus.length === 0 && thoughts.length > 0) {
            selectTodayFocus();
            saveAll();
        }

        // Track focus overlay state (used by tab swiping)
        let focusVisible = false;

        // ===== SETTINGS =====
        const settingsToggle = document.getElementById('settings-toggle');
        const settingsPanel = document.getElementById('settings-panel');
        const settingsClose = document.getElementById('settings-close');
        const settingDailyItems = document.getElementById('setting-daily-items');

        settingsToggle.addEventListener('click', () => settingsPanel.classList.add('visible'));
        settingsClose.addEventListener('click', () => settingsPanel.classList.remove('visible'));

        const savedDailyItems = localStorage.getItem('dailyFocusItems') || '3';
        settingDailyItems.value = savedDailyItems;

        settingDailyItems.addEventListener('change', function() {
            localStorage.setItem('dailyFocusItems', this.value);
            selectTodayFocus();
            saveAll();
            renderFocusCards();
        });

        // ===== TAB SWITCHING =====
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const tabIds = ['capture-tab', 'today-tab', 'all-tab'];
        let currentTabIndex = 0;

        function switchToTab(index) {
            if (index < 0 || index >= tabIds.length) return;
            currentTabIndex = index;
            const tabId = tabIds[index];

            tabButtons.forEach(b => b.classList.remove('active'));
            tabContents.forEach(t => t.classList.remove('active'));
            tabButtons[index].classList.add('active');
            document.getElementById(tabId).classList.add('active');

            if (tabId === 'today-tab') renderTodayTab();
            if (tabId === 'all-tab') renderAllTab();
        }

        tabButtons.forEach((btn, index) => {
            btn.addEventListener('click', function() {
                switchToTab(index);
            });
        });

        // Swipe between tabs
        let tabSwipeStartX = 0;
        let tabSwipeStartY = 0;
        let tabSwiping = false;

        document.body.addEventListener('touchstart', e => {
            // Don't start tab swipe if focus overlay is open
            if (focusVisible) return;
            tabSwipeStartX = e.touches[0].clientX;
            tabSwipeStartY = e.touches[0].clientY;
            tabSwiping = true;
        }, { passive: true });

        document.body.addEventListener('touchmove', e => {
            if (!tabSwiping) return;
            // If vertical movement is greater, cancel tab swipe (let other gestures handle it)
            const diffX = e.touches[0].clientX - tabSwipeStartX;
            const diffY = e.touches[0].clientY - tabSwipeStartY;
            if (Math.abs(diffY) > Math.abs(diffX) + 10) {
                tabSwiping = false;
            }
        }, { passive: true });

        document.body.addEventListener('touchend', e => {
            if (!tabSwiping) return;
            tabSwiping = false;

            // Don't switch tabs if focus overlay is open
            if (focusVisible) return;

            const diffX = e.changedTouches[0].clientX - tabSwipeStartX;
            const diffY = e.changedTouches[0].clientY - tabSwipeStartY;

            // Only trigger if horizontal swipe is dominant and far enough
            if (Math.abs(diffX) > 80 && Math.abs(diffX) > Math.abs(diffY) * 2) {
                if (diffX < 0) {
                    // Swipe left - next tab
                    switchToTab(currentTabIndex + 1);
                } else {
                    // Swipe right - previous tab
                    switchToTab(currentTabIndex - 1);
                }
            }
        });

        // ===== BEDTIME MODE =====
        const bedtimeToggle = document.getElementById('bedtime-toggle');
        const iconMoon = bedtimeToggle.querySelector('.icon-moon');
        const iconSun = bedtimeToggle.querySelector('.icon-sun');
        let isBedtimeMode = false;

        function checkBedtimeTime() {
            const hour = new Date().getHours();
            return hour >= 21 || hour < 6;
        }

        function updateBedtimeIcon(enabled) {
            iconMoon.style.display = enabled ? 'none' : 'block';
            iconSun.style.display = enabled ? 'block' : 'none';
        }

        function setBedtimeMode(enabled) {
            isBedtimeMode = enabled;
            document.body.classList.toggle('bedtime-mode', enabled);
            updateBedtimeIcon(enabled);
            localStorage.setItem('bedtimeManualOverride', 'true');
            localStorage.setItem('bedtimeMode', enabled.toString());
        }

        function initBedtimeMode() {
            const manualOverride = localStorage.getItem('bedtimeManualOverride');
            const savedMode = localStorage.getItem('bedtimeMode');
            isBedtimeMode = (manualOverride === 'true' && savedMode !== null)
                ? savedMode === 'true'
                : checkBedtimeTime();
            if (isBedtimeMode) {
                document.body.classList.add('bedtime-mode');
                updateBedtimeIcon(true);
            }
        }

        bedtimeToggle.addEventListener('click', () => setBedtimeMode(!isBedtimeMode));
        initBedtimeMode();

        // ===== CONFIRMATION MESSAGES =====
        const confirmationMessages = ["Got it.", "Noted.", "Saved.", "Done.", "All yours.", "On the list.", "Won't forget."];
        const bedtimeMessages = ["Captured.", "It's safe.", "Letting go.", "Held for you.", "Set aside.", "Tomorrow's ready.", "Tucked away."];

        function getRandomConfirmation() {
            const messages = isBedtimeMode ? bedtimeMessages : confirmationMessages;
            return messages[Math.floor(Math.random() * messages.length)];
        }

        // ===== CAPTURE =====
        const input = document.getElementById('thought-input');
        const bigMicButton = document.getElementById('big-mic-button');
        const micContainer = document.getElementById('mic-container');
        const confirmation = document.getElementById('capture-confirmation');

        function haptic(style) {
            if ('vibrate' in navigator) {
                navigator.vibrate(style === 'light' ? 10 : style === 'medium' ? 20 : 30);
            }
        }

        function showConfirmation(message) {
            confirmation.textContent = message || getRandomConfirmation();
            confirmation.classList.add('visible');
            setTimeout(() => confirmation.classList.remove('visible'), 2000);
        }

        function captureThought(text) {
            const thought = (text || input.value).trim();
            if (thought === '') return;

            thoughts.push({ text: thought, skips: 0 });
            input.value = '';

            // If today's focus isn't full, add to it
            const maxFocus = parseInt(localStorage.getItem('dailyFocusItems') || '3');
            if (todayFocus.length < maxFocus) {
                todayFocus.push({ text: thought, skips: 0 });
            }

            saveAll();
            showConfirmation();
            haptic('medium');
        }

        input.addEventListener('keydown', e => {
            if (e.key === 'Enter') captureThought();
        });

        // Voice capture
        let recognition = null;
        let isListening = false;

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onresult = function(e) {
                recognition.stop();
                captureThought(e.results[0][0].transcript);
            };

            recognition.onend = function() {
                isListening = false;
                bigMicButton.classList.remove('listening');
                micContainer.classList.remove('listening');
                bigMicButton.textContent = 'tap to capture';
            };

            recognition.onerror = recognition.onend;

            bigMicButton.addEventListener('click', function() {
                if (isListening) {
                    recognition.stop();
                } else {
                    recognition.start();
                    isListening = true;
                    bigMicButton.classList.add('listening');
                    micContainer.classList.add('listening');
                    bigMicButton.textContent = 'listening...';
                }
            });
        } else {
            bigMicButton.disabled = true;
            bigMicButton.textContent = 'voice not supported';
        }

        // ===== FOCUS OVERLAY =====
        const focusOverlay = document.getElementById('focus-overlay');
        const focusHandle = document.getElementById('focus-handle');
        const focusContainer = document.getElementById('focus-cards-container');
        const captureTab = document.getElementById('capture-tab');
        let currentCardIndex = 0;

        function openFocusOverlay() {
            focusVisible = true;
            focusOverlay.classList.add('animating');
            focusOverlay.classList.add('visible');
            focusOverlay.style.transform = '';
            renderFocusCards();
            setTimeout(() => focusOverlay.classList.remove('animating'), 300);
        }

        function closeFocusOverlay() {
            focusVisible = false;
            focusOverlay.classList.add('animating');
            focusOverlay.classList.remove('visible');
            focusOverlay.style.transform = '';
            setTimeout(() => focusOverlay.classList.remove('animating'), 300);
        }

        function renderFocusCards() {
            focusContainer.innerHTML = '';

            // Filter out items already handled today
            const handledTexts = [...laterToday.map(i => i.text), ...completedToday.map(i => i.text)];
            const remaining = todayFocus.filter(item => !handledTexts.includes(item.text));

            if (thoughts.length === 0) {
                focusContainer.innerHTML = `
                    <div id="focus-message">
                        <div id="focus-message-title">nothing captured yet</div>
                        <div id="focus-message-subtitle">swipe down and add your first thought</div>
                    </div>`;
                return;
            }

            if (remaining.length === 0) {
                const allDone = todayFocus.length > 0 && completedToday.length === todayFocus.length;
                focusContainer.innerHTML = `
                    <div id="focus-message">
                        <div id="focus-message-title">${allDone ? 'nice work' : 'all set for now'}</div>
                        <div id="focus-message-subtitle">${allDone ? 'you completed everything today' : 'see you tomorrow'}</div>
                    </div>`;
                return;
            }

            // Show all remaining cards
            remaining.forEach((item, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'focus-card-wrapper';
                wrapper.innerHTML = `
                    <div class="swipe-bg swipe-bg-left">later</div>
                    <div class="swipe-bg swipe-bg-right">done</div>
                    <div class="focus-card">
                        <div class="focus-card-text">${item.text}</div>
                    </div>
                `;
                setupCardSwipe(wrapper, item);
                focusContainer.appendChild(wrapper);
            });
        }

        function setupCardSwipe(wrapper, item) {
            const card = wrapper.querySelector('.focus-card');
            const bgLeft = wrapper.querySelector('.swipe-bg-left');
            const bgRight = wrapper.querySelector('.swipe-bg-right');
            let startX = 0, currentX = 0, swiping = false;

            card.addEventListener('touchstart', e => {
                startX = e.touches[0].clientX;
                currentX = startX;
                swiping = true;
                card.classList.add('swiping');
            }, { passive: true });

            card.addEventListener('touchmove', e => {
                if (!swiping) return;
                currentX = e.touches[0].clientX;
                const diff = currentX - startX;
                card.style.transform = `translateX(${diff}px)`;

                // Show colored background based on direction
                if (diff > 30) {
                    const opacity = Math.min(1, (diff - 30) / 50);
                    bgRight.style.opacity = opacity;
                    bgLeft.style.opacity = 0;
                } else if (diff < -30) {
                    const opacity = Math.min(1, (-diff - 30) / 50);
                    bgLeft.style.opacity = opacity;
                    bgRight.style.opacity = 0;
                } else {
                    bgLeft.style.opacity = 0;
                    bgRight.style.opacity = 0;
                }
            }, { passive: true });

            card.addEventListener('touchend', e => {
                if (!swiping) return;
                swiping = false;
                card.classList.remove('swiping');

                const diff = currentX - startX;

                if (diff > 80) {
                    // Swipe right - done
                    card.style.transform = 'translateX(100vw)';
                    haptic('medium');
                    setTimeout(() => {
                        wrapper.classList.add('removing');
                        setTimeout(() => {
                            completedToday.push(item);
                            thoughts = thoughts.filter(t => t.text !== item.text);
                            completedAllTime.push(item.text);
                            saveAll();
                            renderFocusCards();
                        }, 300);
                    }, 200);
                } else if (diff < -80) {
                    // Swipe left - later
                    card.style.transform = 'translateX(-100vw)';
                    haptic('light');
                    setTimeout(() => {
                        wrapper.classList.add('removing');
                        setTimeout(() => {
                            laterToday.push(item);
                            const idx = thoughts.findIndex(t => t.text === item.text);
                            if (idx > -1) {
                                const t = thoughts.splice(idx, 1)[0];
                                t.skips = (t.skips || 0) + 1;
                                thoughts.push(t);
                            }
                            saveAll();
                            renderFocusCards();
                        }, 300);
                    }, 200);
                } else {
                    // Snap back
                    card.style.transform = '';
                    bgLeft.style.opacity = 0;
                    bgRight.style.opacity = 0;
                }
            });
        }

        // Swipe up on capture tab to open focus overlay
        let captureStartY = 0, captureDragging = false;

        captureTab.addEventListener('touchstart', e => {
            if (focusVisible) return;
            const touch = e.touches[0];
            // Only trigger from bottom half
            if (touch.clientY > window.innerHeight * 0.5) {
                captureStartY = touch.clientY;
                captureDragging = true;
            }
        }, { passive: true });

        captureTab.addEventListener('touchmove', e => {
            if (!captureDragging || focusVisible) return;
            const diff = captureStartY - e.touches[0].clientY;
            if (diff > 10) {
                const progress = Math.min(diff / (window.innerHeight * 0.5), 1);
                focusOverlay.style.transform = `translateY(${(1 - progress) * 100}%)`;
            }
        }, { passive: true });

        captureTab.addEventListener('touchend', e => {
            if (!captureDragging) return;
            captureDragging = false;
            const diff = captureStartY - e.changedTouches[0].clientY;
            if (diff > 100) {
                openFocusOverlay();
            } else {
                focusOverlay.style.transform = '';
            }
        });

        // Swipe down anywhere on focus overlay to close
        let overlayStartY = 0, overlayStartX = 0, overlayDragging = false, overlayDragConfirmed = false;

        focusOverlay.addEventListener('touchstart', e => {
            overlayStartY = e.touches[0].clientY;
            overlayStartX = e.touches[0].clientX;
            overlayDragging = true;
            overlayDragConfirmed = false;
        }, { passive: true });

        focusOverlay.addEventListener('touchmove', e => {
            if (!overlayDragging) return;

            const diffY = e.touches[0].clientY - overlayStartY;
            const diffX = e.touches[0].clientX - overlayStartX;

            // Only handle if vertical swipe is dominant and downward
            if (!overlayDragConfirmed) {
                if (Math.abs(diffX) > 20) {
                    // Horizontal swipe - let card handle it
                    overlayDragging = false;
                    return;
                }
                if (diffY > 20) {
                    overlayDragConfirmed = true;
                }
            }

            if (overlayDragConfirmed && diffY > 0) {
                focusOverlay.style.transform = `translateY(${diffY}px)`;
            }
        }, { passive: true });

        focusOverlay.addEventListener('touchend', e => {
            if (!overlayDragging) return;
            overlayDragging = false;

            if (!overlayDragConfirmed) {
                return;
            }

            const diff = e.changedTouches[0].clientY - overlayStartY;
            if (diff > 100) {
                closeFocusOverlay();
            } else {
                focusOverlay.classList.add('animating');
                focusOverlay.style.transform = '';
                setTimeout(() => focusOverlay.classList.remove('animating'), 300);
            }
        });

        // ===== TODAY TAB =====
        const laterList = document.getElementById('later-list');
        const completedTodayList = document.getElementById('completed-today-list');

        function renderTodayTab() {
            laterList.innerHTML = laterToday.length === 0
                ? '<li class="empty-section">nothing deferred yet</li>'
                : laterToday.map(item => `<li class="task-item later">${item.text}</li>`).join('');

            completedTodayList.innerHTML = completedToday.length === 0
                ? '<li class="empty-section">nothing completed yet</li>'
                : completedToday.map(item => `<li class="task-item completed">${item.text}</li>`).join('');
        }

        // ===== ALL TAB =====
        const backlogList = document.getElementById('backlog-list');

        function renderAllTab() {
            // Show thoughts not in today's focus
            const focusTexts = todayFocus.map(t => t.text);
            const backlog = thoughts.filter(t => !focusTexts.includes(t.text));

            if (backlog.length === 0) {
                backlogList.innerHTML = '<div class="empty-section">no items in backlog</div>';
                return;
            }

            backlogList.innerHTML = backlog.map(item => `
                <div class="backlog-item">
                    <div class="backlog-item-text">${item.text}</div>
                    ${item.skips > 0 ? `<div class="backlog-item-meta">skipped ${item.skips}x</div>` : ''}
                </div>
            `).join('');
        }

        // ===== SERVICE WORKER =====
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed:', err));
        }

        // Check for daily reset periodically
        setInterval(checkDailyReset, 60000);
    </script>
</body>
</html>
