<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Overwhelm</title>

    <!-- PWA setup -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4a90a4">
    <!-- iOS specific -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Overwhelm">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        :root {
            --bg-color: #f5f5f5;
            --card-bg: white;
            --text-color: #333;
            --text-muted: #888;
            --text-light: #666;
            --border-color: #ccc;
            --input-bg: white;
            --shadow: rgba(0,0,0,0.1);
        }

        .dark-mode {
            --bg-color: #1a1a2e;
            --card-bg: #16213e;
            --text-color: #eee;
            --text-muted: #aaa;
            --text-light: #bbb;
            --border-color: #333;
            --input-bg: #0f0f23;
            --shadow: rgba(0,0,0,0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            background-color: var(--bg-color);
            transition: background-color 0.3s;
        }

        #header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: var(--text-color);
            font-size: 24px;
            margin: 0;
        }

        #theme-toggle {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        #input-row {
            display: flex;
            gap: 8px;
        }

        #thought-input {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            background-color: var(--input-bg);
            color: var(--text-color);
        }

        #voice-button {
            padding: 12px 16px;
            font-size: 16px;
            background-color: #666;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        #voice-button:hover {
            background-color: #555;
        }

        #voice-button.listening {
            background-color: #e74c3c;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        #add-button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            font-size: 16px;
            background-color: #4a90a4;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        #add-button:hover {
            background-color: #3a7a94;
        }

        #today-item {
            margin-top: 30px;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow);
        }

        #today-label {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        #today-text {
            font-size: 18px;
            color: var(--text-color);
        }

        #capture-confirmation {
            margin-top: 10px;
            padding: 10px;
            background-color: #d4edda;
            color: #155724;
            border-radius: 8px;
            text-align: center;
            display: none;
        }

        #thought-count {
            margin-top: 15px;
            font-size: 14px;
            color: var(--text-muted);
        }

        #button-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        #done-button {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            background-color: #5cb85c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        #done-button:hover {
            background-color: #4cae4c;
        }

        #done-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #skip-button {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            background-color: #f0ad4e;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        #skip-button:hover {
            background-color: #ec971f;
        }

        #skip-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #skip-count {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 5px;
        }

        #completed-section {
            margin-top: 30px;
        }

        #completed-header {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 10px;
            cursor: pointer;
        }

        #completed-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #completed-list li {
            padding: 10px 12px;
            background-color: var(--card-bg);
            border-radius: 6px;
            margin-bottom: 6px;
            color: var(--text-light);
            font-size: 14px;
            border-left: 3px solid #5cb85c;
        }
    </style>
</head>
<body>
    <div id="header-row">
        <h1>Daily Overwhelm</h1>
        <button id="theme-toggle" title="Toggle dark mode"></button>
    </div>

    <div id="input-row">
        <input type="text" id="thought-input" placeholder="What's on your mind?">
        <button id="voice-button" title="Voice capture">Mic</button>
    </div>
    <button id="add-button">Capture</button>
    <div id="capture-confirmation">Captured! You can let that one go.</div>
    <div id="thought-count"></div>

    <div id="today-item">
        <div id="today-label">Your focus for today:</div>
        <div id="today-text">Nothing yet - add something above</div>
        <div id="skip-count"></div>
        <div id="button-row">
            <button id="done-button">Done</button>
            <button id="skip-button">Later</button>
        </div>
    </div>

    <div id="completed-section">
        <div id="completed-header"></div>
        <ul id="completed-list"></ul>
    </div>

    <script>
        // This is where the "brain" of the app lives

        // Dark mode setup
        const themeToggle = document.getElementById('theme-toggle');
        let darkMode = localStorage.getItem('darkMode') === 'true';

        function applyTheme() {
            if (darkMode) {
                document.body.classList.add('dark-mode');
                themeToggle.textContent = 'â˜€ï¸';
            } else {
                document.body.classList.remove('dark-mode');
                themeToggle.textContent = 'ðŸŒ™';
            }
        }

        themeToggle.addEventListener('click', function() {
            darkMode = !darkMode;
            localStorage.setItem('darkMode', darkMode);
            applyTheme();
        });

        // Apply theme immediately
        applyTheme();

        // Load saved thoughts from localStorage, or start with empty array
        let thoughts = JSON.parse(localStorage.getItem('thoughts')) || [];
        let completed = JSON.parse(localStorage.getItem('completed')) || [];

        // Migrate old string format to new object format { text, skips }
        thoughts = thoughts.map(function(item) {
            if (typeof item === 'string') {
                return { text: item, skips: 0 };
            }
            return item;
        });

        // Find the elements on the page so we can interact with them
        const input = document.getElementById('thought-input');
        const button = document.getElementById('add-button');
        const todayText = document.getElementById('today-text');
        const confirmation = document.getElementById('capture-confirmation');
        const countDisplay = document.getElementById('thought-count');
        const doneButton = document.getElementById('done-button');
        const skipButton = document.getElementById('skip-button');
        const skipCountDisplay = document.getElementById('skip-count');
        const completedHeader = document.getElementById('completed-header');
        const completedList = document.getElementById('completed-list');

        // Function to save thoughts to localStorage
        function saveThoughts() {
            localStorage.setItem('thoughts', JSON.stringify(thoughts));
        }

        // Function to save completed items to localStorage
        function saveCompleted() {
            localStorage.setItem('completed', JSON.stringify(completed));
        }

        // Function to update what's displayed on screen
        function updateDisplay() {
            // Update the focus item
            if (thoughts.length > 0) {
                const current = thoughts[0];
                todayText.textContent = current.text;
                countDisplay.textContent = thoughts.length + ' thought' + (thoughts.length === 1 ? '' : 's') + ' captured';
                doneButton.disabled = false;
                skipButton.disabled = false;

                // Show skip count if item has been skipped before
                if (current.skips > 0) {
                    skipCountDisplay.textContent = 'Skipped ' + current.skips + ' time' + (current.skips === 1 ? '' : 's');
                } else {
                    skipCountDisplay.textContent = '';
                }
            } else {
                todayText.textContent = 'Nothing yet - add something above';
                countDisplay.textContent = '';
                skipCountDisplay.textContent = '';
                doneButton.disabled = true;
                skipButton.disabled = true;
            }

            // Update the completed list
            if (completed.length > 0) {
                completedHeader.textContent = completed.length + ' completed';
                completedList.innerHTML = '';
                // Show most recent first, limit to 10
                completed.slice(-10).reverse().forEach(function(item) {
                    const li = document.createElement('li');
                    li.textContent = item;
                    completedList.appendChild(li);
                });
            } else {
                completedHeader.textContent = '';
                completedList.innerHTML = '';
            }
        }

        // Function to show brief confirmation message
        function showConfirmation() {
            confirmation.style.display = 'block';
            setTimeout(function() {
                confirmation.style.display = 'none';
            }, 2000); // Hide after 2 seconds
        }

        // Function to capture a thought (reusable)
        function captureThought() {
            const thought = input.value;

            if (thought.trim() !== '') {
                // Store as object with text and skip count
                thoughts.push({ text: thought, skips: 0 });
                saveThoughts();
                input.value = '';
                updateDisplay();
                showConfirmation();
                console.log('All thoughts:', thoughts);
            }
        }

        // When the button is clicked
        button.addEventListener('click', captureThought);

        // When Enter is pressed in the input field
        input.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                captureThought();
            }
        });

        // When the Done button is clicked
        doneButton.addEventListener('click', function() {
            if (thoughts.length > 0) {
                // Move the first thought to completed (store just the text)
                const doneThought = thoughts.shift();
                completed.push(doneThought.text);

                // Save both lists
                saveThoughts();
                saveCompleted();

                // Update the display
                updateDisplay();

                console.log('Completed:', doneThought.text);
            }
        });

        // When the Skip/Later button is clicked
        skipButton.addEventListener('click', function() {
            if (thoughts.length > 1) {
                // Remove from front, increment skips, add to back
                const skippedThought = thoughts.shift();
                skippedThought.skips += 1;
                thoughts.push(skippedThought);

                // Save and update
                saveThoughts();
                updateDisplay();

                console.log('Skipped:', skippedThought.text, '- total skips:', skippedThought.skips);
            } else if (thoughts.length === 1) {
                // Can't skip if it's the only item - just increment skip count
                thoughts[0].skips += 1;
                saveThoughts();
                updateDisplay();
                console.log('Only one item - nowhere to skip to');
            }
        });

        // Voice capture setup
        const voiceButton = document.getElementById('voice-button');
        let recognition = null;
        let isListening = false;

        // Check if browser supports speech recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            // Create speech recognition instance
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();

            // Settings
            recognition.continuous = false;      // Stop after one phrase
            recognition.interimResults = false;  // Only final results
            recognition.lang = 'en-US';          // Language

            // When speech is recognized
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                input.value = transcript;
                recognition.stop();  // Explicitly stop the microphone
                captureThought();  // Auto-capture after voice input
            };

            // When recognition ends
            recognition.onend = function() {
                isListening = false;
                voiceButton.classList.remove('listening');
                voiceButton.textContent = 'Mic';
            };

            // Handle errors
            recognition.onerror = function(event) {
                console.log('Speech recognition error:', event.error);
                isListening = false;
                voiceButton.classList.remove('listening');
                voiceButton.textContent = 'Mic';
            };

            // Toggle listening when button clicked
            voiceButton.addEventListener('click', function() {
                if (isListening) {
                    recognition.stop();
                } else {
                    recognition.start();
                    isListening = true;
                    voiceButton.classList.add('listening');
                    voiceButton.textContent = '...';
                }
            });
        } else {
            // Browser doesn't support speech recognition
            voiceButton.disabled = true;
            voiceButton.title = 'Voice not supported in this browser';
        }

        // When the page loads, show any saved thoughts
        updateDisplay();

        // Register the service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(function(registration) {
                    console.log('Service Worker registered');
                })
                .catch(function(error) {
                    console.log('Service Worker registration failed:', error);
                });
        }
    </script>
</body>
</html>
