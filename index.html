<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Daily Overwhelm</title>

    <!-- PWA setup -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1a2e">
    <!-- iOS specific -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Overwhelm">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        * {
            box-sizing: border-box;
        }

        :root {
            --bg-color: #1a1a2e;
            --card-bg: #16213e;
            --text-color: #eee;
            --text-muted: #aaa;
            --text-light: #bbb;
            --border-color: #333;
            --input-bg: #0f0f23;
            --shadow: rgba(0,0,0,0.3);
            --accent: #4a90a4;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
        }

        /* Tab content area */
        .tab-content {
            flex: 1;
            display: none;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .tab-content.active {
            display: flex;
        }

        /* ===== CAPTURE TAB ===== */
        #capture-tab {
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        #mic-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #big-mic-button {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background-color: var(--accent);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 4px 20px rgba(74, 144, 164, 0.4);
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s;
            position: relative;
            z-index: 2;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            font-size: 15px;
            font-weight: 400;
            letter-spacing: 0.5px;
            text-transform: lowercase;
        }

        #big-mic-button:hover {
            transform: scale(1.03);
        }

        #big-mic-button:active {
            transform: scale(0.98);
        }

        /* Ripple rings */
        .ripple {
            position: absolute;
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: 1px solid var(--accent);
            opacity: 0;
            z-index: 1;
            pointer-events: none;
        }

        .ripple-1 {
            animation: ripple 7s ease-out infinite;
        }

        .ripple-2 {
            animation: ripple 7s ease-out infinite 2s;
        }

        @keyframes ripple {
            0% {
                transform: scale(1);
                opacity: 0.4;
            }
            57% {
                transform: scale(1.8);
                opacity: 0;
            }
            100% {
                transform: scale(1.8);
                opacity: 0;
            }
        }

        /* Stop ripples when listening */
        #mic-container.listening .ripple {
            animation: none;
            opacity: 0;
        }

        #big-mic-button.listening {
            background-color: #e74c3c;
            box-shadow: 0 4px 30px rgba(231, 76, 60, 0.5);
            animation: pulse-listening 1s infinite;
        }

        @keyframes pulse-listening {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        #capture-confirmation {
            margin-top: 30px;
            padding: 15px 25px;
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: 12px;
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #capture-confirmation.visible {
            opacity: 1;
        }

        #text-input-section {
            margin-top: 40px;
            width: 100%;
            max-width: 300px;
        }

        #thought-input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--text-color);
            text-align: center;
        }

        #thought-input::placeholder {
            color: var(--text-muted);
        }

        /* ===== TASKS TAB ===== */
        #tasks-tab {
            padding-top: 40px;
        }

        #today-item-container {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
        }

        .swipe-background {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            display: flex;
            align-items: center;
            padding: 0 30px;
            font-size: 18px;
            font-weight: 500;
            color: white;
            pointer-events: none;
            text-transform: lowercase;
        }

        #swipe-bg-left {
            background-color: #f0ad4e;
            justify-content: flex-start;
        }

        #swipe-bg-right {
            background-color: #5cb85c;
            justify-content: flex-end;
        }

        .swipe-label {
            opacity: 0;
            transition: opacity 0.15s;
        }

        #today-item {
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow);
            position: relative;
            transition: transform 0.1s ease-out;
            touch-action: pan-y pinch-zoom;
        }

        #today-item.swiping {
            transition: none;
        }

        #today-item.swipe-away-right {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            transform: translateX(100%);
            opacity: 0;
        }

        #today-item.swipe-away-left {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            transform: translateX(-100%);
            opacity: 0;
        }

        #swipe-instruction {
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 10px;
            opacity: 0.6;
        }

        #today-label {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        #today-text {
            font-size: 20px;
            color: var(--text-color);
            line-height: 1.4;
        }

        #skip-count {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 8px;
        }

        #thought-count {
            font-size: 14px;
            color: var(--text-muted);
            margin-top: 15px;
        }

        #secondary-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .secondary-btn {
            flex: 1;
            padding: 10px;
            font-size: 14px;
            background-color: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
        }

        .secondary-btn:hover {
            background-color: var(--border-color);
        }

        .secondary-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        #remove-btn {
            color: #e74c3c;
            border-color: #e74c3c40;
        }

        #remove-btn:hover {
            background-color: #e74c3c20;
        }

        /* Edit modal */
        #edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.8);
            z-index: 100;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        #edit-modal.visible {
            display: flex;
        }

        #edit-modal-content {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 400px;
        }

        #edit-modal-title {
            font-size: 16px;
            color: var(--text-muted);
            margin-bottom: 15px;
        }

        #edit-input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--text-color);
            margin-bottom: 15px;
        }

        #edit-modal-buttons {
            display: flex;
            gap: 10px;
        }

        #edit-modal-buttons button {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        #edit-cancel {
            background-color: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border-color);
        }

        #edit-save {
            background-color: var(--accent);
            color: white;
        }

        #completed-section {
            margin-top: 30px;
        }

        #completed-header {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        #completed-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #completed-list li {
            padding: 12px 14px;
            background-color: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 8px;
            color: var(--text-light);
            font-size: 14px;
            border-left: 3px solid #5cb85c;
        }

        /* ===== TAB BAR ===== */
        #tab-bar {
            display: flex;
            background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
            padding: 10px 0;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }

        .tab-button {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 12px;
            padding: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .tab-button .tab-icon {
            font-size: 24px;
        }

        .tab-button.active {
            color: var(--accent);
        }
    </style>
</head>
<body>
    <!-- CAPTURE TAB -->
    <div id="capture-tab" class="tab-content active">
        <div id="mic-container">
            <div class="ripple ripple-1"></div>
            <div class="ripple ripple-2"></div>
            <button id="big-mic-button">tap to capture</button>
        </div>
        <div id="capture-confirmation"></div>
        <div id="text-input-section">
            <input type="text" id="thought-input" placeholder="or type here">
        </div>
    </div>

    <!-- TASKS TAB -->
    <div id="tasks-tab" class="tab-content">
        <div id="today-item-container">
            <div id="swipe-bg-left" class="swipe-background">
                <span class="swipe-label" id="swipe-label-left">later</span>
            </div>
            <div id="swipe-bg-right" class="swipe-background">
                <span class="swipe-label" id="swipe-label-right">done</span>
            </div>
            <div id="today-item">
                <div id="today-label">your focus for today</div>
                <div id="today-text">nothing yet</div>
                <div id="skip-count"></div>
                <div id="thought-count"></div>
                <div id="secondary-actions">
                    <button id="edit-btn" class="secondary-btn">edit</button>
                    <button id="remove-btn" class="secondary-btn">remove</button>
                </div>
            </div>
        </div>
        <div id="swipe-instruction">swipe right to complete, left for later</div>

        <div id="completed-section">
            <div id="completed-header"></div>
            <ul id="completed-list"></ul>
        </div>
    </div>

    <!-- EDIT MODAL -->
    <div id="edit-modal">
        <div id="edit-modal-content">
            <div id="edit-modal-title">edit thought</div>
            <input type="text" id="edit-input" placeholder="update your thought">
            <div id="edit-modal-buttons">
                <button id="edit-cancel">cancel</button>
                <button id="edit-save">save</button>
            </div>
        </div>
    </div>

    <!-- TAB BAR -->
    <div id="tab-bar">
        <button class="tab-button active" data-tab="capture-tab">
            <span class="tab-icon">+</span>
            <span>Capture</span>
        </button>
        <button class="tab-button" data-tab="tasks-tab">
            <span class="tab-icon">â˜°</span>
            <span>Tasks</span>
        </button>
    </div>

    <script>
        // ===== TAB SWITCHING =====
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(function(btn) {
            btn.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');

                // Update active states
                tabButtons.forEach(b => b.classList.remove('active'));
                tabContents.forEach(t => t.classList.remove('active'));

                this.classList.add('active');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // ===== CONFIRMATION MESSAGES =====
        const confirmationMessages = [
            "Got it.",
            "Noted.",
            "Saved.",
            "Done.",
            "All yours.",
            "On the list.",
            "Won't forget."
        ];

        function getRandomConfirmation() {
            const index = Math.floor(Math.random() * confirmationMessages.length);
            return confirmationMessages[index];
        }

        // ===== DATA =====
        let thoughts = JSON.parse(localStorage.getItem('thoughts')) || [];
        let completed = JSON.parse(localStorage.getItem('completed')) || [];

        // Migrate old string format to new object format { text, skips }
        thoughts = thoughts.map(function(item) {
            if (typeof item === 'string') {
                return { text: item, skips: 0 };
            }
            return item;
        });

        // ===== ELEMENTS =====
        const input = document.getElementById('thought-input');
        const bigMicButton = document.getElementById('big-mic-button');
        const micContainer = document.getElementById('mic-container');
        const confirmation = document.getElementById('capture-confirmation');
        const todayText = document.getElementById('today-text');
        const countDisplay = document.getElementById('thought-count');
        const skipCountDisplay = document.getElementById('skip-count');
        const completedHeader = document.getElementById('completed-header');
        const completedList = document.getElementById('completed-list');
        const editBtn = document.getElementById('edit-btn');
        const removeBtn = document.getElementById('remove-btn');
        const editModal = document.getElementById('edit-modal');
        const editInput = document.getElementById('edit-input');
        const editCancel = document.getElementById('edit-cancel');
        const editSave = document.getElementById('edit-save');
        const todayItem = document.getElementById('today-item');
        const swipeLabelLeft = document.getElementById('swipe-label-left');
        const swipeLabelRight = document.getElementById('swipe-label-right');
        const swipeBgLeft = document.getElementById('swipe-bg-left');
        const swipeBgRight = document.getElementById('swipe-bg-right');

        // ===== FUNCTIONS =====
        function saveThoughts() {
            localStorage.setItem('thoughts', JSON.stringify(thoughts));
        }

        function saveCompleted() {
            localStorage.setItem('completed', JSON.stringify(completed));
        }

        function updateDisplay() {
            // Update the focus item
            if (thoughts.length > 0) {
                const current = thoughts[0];
                todayText.textContent = current.text;
                countDisplay.textContent = thoughts.length + ' thought' + (thoughts.length === 1 ? '' : 's') + ' captured';
                editBtn.disabled = false;
                removeBtn.disabled = false;

                if (current.skips > 0) {
                    skipCountDisplay.textContent = 'skipped ' + current.skips + ' time' + (current.skips === 1 ? '' : 's');
                } else {
                    skipCountDisplay.textContent = '';
                }
            } else {
                todayText.textContent = 'nothing yet';
                countDisplay.textContent = '';
                skipCountDisplay.textContent = '';
                editBtn.disabled = true;
                removeBtn.disabled = true;
            }

            // Update the completed list
            if (completed.length > 0) {
                completedHeader.textContent = completed.length + ' completed';
                completedList.innerHTML = '';
                completed.slice(-10).reverse().forEach(function(item) {
                    const li = document.createElement('li');
                    li.textContent = item;
                    completedList.appendChild(li);
                });
            } else {
                completedHeader.textContent = '';
                completedList.innerHTML = '';
            }
        }

        function showConfirmation(message) {
            confirmation.textContent = message || getRandomConfirmation();
            confirmation.classList.add('visible');
            setTimeout(function() {
                confirmation.classList.remove('visible');
            }, 2000);
        }

        // Haptic feedback
        function haptic(style) {
            if ('vibrate' in navigator) {
                if (style === 'light') {
                    navigator.vibrate(10);
                } else if (style === 'medium') {
                    navigator.vibrate(20);
                } else {
                    navigator.vibrate(30);
                }
            }
        }

        function captureThought(text) {
            const thought = text || input.value;

            if (thought.trim() !== '') {
                thoughts.push({ text: thought, skips: 0 });
                saveThoughts();
                input.value = '';
                updateDisplay();
                showConfirmation();
                haptic('medium');
                console.log('Captured:', thought);
            }
        }

        // ===== EVENT LISTENERS =====

        // Text input - Enter key
        input.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                captureThought();
            }
        });

        // Edit button - open modal
        editBtn.addEventListener('click', function() {
            if (thoughts.length > 0) {
                editInput.value = thoughts[0].text;
                editModal.classList.add('visible');
                editInput.focus();
            }
        });

        // Edit cancel
        editCancel.addEventListener('click', function() {
            editModal.classList.remove('visible');
        });

        // Edit save
        editSave.addEventListener('click', function() {
            if (thoughts.length > 0 && editInput.value.trim() !== '') {
                thoughts[0].text = editInput.value.trim();
                saveThoughts();
                updateDisplay();
                editModal.classList.remove('visible');
                haptic('light');
                console.log('Edited thought');
            }
        });

        // Edit modal - Enter to save
        editInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                editSave.click();
            } else if (event.key === 'Escape') {
                editCancel.click();
            }
        });

        // Click outside modal to close
        editModal.addEventListener('click', function(event) {
            if (event.target === editModal) {
                editModal.classList.remove('visible');
            }
        });

        // Remove button
        removeBtn.addEventListener('click', function() {
            if (thoughts.length > 0) {
                const removed = thoughts.shift();
                saveThoughts();
                updateDisplay();
                haptic('medium');
                console.log('Removed:', removed.text);
            }
        });

        // ===== SWIPE GESTURES =====
        let touchStartX = 0;
        let touchCurrentX = 0;
        let isSwiping = false;
        const swipeThreshold = 80;

        todayItem.addEventListener('touchstart', function(e) {
            if (thoughts.length === 0) return;
            touchStartX = e.touches[0].clientX;
            isSwiping = true;
            todayItem.classList.add('swiping');
        }, { passive: true });

        todayItem.addEventListener('touchmove', function(e) {
            if (!isSwiping || thoughts.length === 0) return;
            touchCurrentX = e.touches[0].clientX;
            const diff = touchCurrentX - touchStartX;

            // Move the card
            todayItem.style.transform = 'translateX(' + diff + 'px)';

            // Show hint labels based on direction
            if (diff > 30) {
                // Swiping right - show "done" label
                swipeLabelRight.style.opacity = Math.min(1, (diff - 30) / 50);
                swipeLabelLeft.style.opacity = 0;
            } else if (diff < -30) {
                // Swiping left - show "later" label
                swipeLabelLeft.style.opacity = Math.min(1, (-diff - 30) / 50);
                swipeLabelRight.style.opacity = 0;
            } else {
                swipeLabelLeft.style.opacity = 0;
                swipeLabelRight.style.opacity = 0;
            }
        }, { passive: true });

        todayItem.addEventListener('touchend', function(e) {
            if (!isSwiping || thoughts.length === 0) return;
            isSwiping = false;
            todayItem.classList.remove('swiping');

            const diff = touchCurrentX - touchStartX;

            if (diff > swipeThreshold) {
                // Swipe right - Done
                todayItem.classList.add('swipe-away-right');
                haptic('medium');
                setTimeout(function() {
                    const doneThought = thoughts.shift();
                    completed.push(doneThought.text);
                    saveThoughts();
                    saveCompleted();
                    resetSwipeState();
                    updateDisplay();
                }, 300);
            } else if (diff < -swipeThreshold) {
                // Swipe left - Later
                todayItem.classList.add('swipe-away-left');
                haptic('light');
                setTimeout(function() {
                    if (thoughts.length > 1) {
                        const skipped = thoughts.shift();
                        skipped.skips += 1;
                        thoughts.push(skipped);
                    } else if (thoughts.length === 1) {
                        thoughts[0].skips += 1;
                    }
                    saveThoughts();
                    resetSwipeState();
                    updateDisplay();
                }, 300);
            } else {
                // Not enough to trigger action
                resetSwipeState();
            }
        });

        function resetSwipeState() {
            todayItem.style.transform = '';
            todayItem.classList.remove('swipe-away-left', 'swipe-away-right', 'swiping');
            swipeLabelLeft.style.opacity = 0;
            swipeLabelRight.style.opacity = 0;
            touchStartX = 0;
            touchCurrentX = 0;
        }

        // ===== VOICE CAPTURE =====
        let recognition = null;
        let isListening = false;

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();

            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                recognition.stop();
                captureThought(transcript);
            };

            recognition.onend = function() {
                isListening = false;
                bigMicButton.classList.remove('listening');
                micContainer.classList.remove('listening');
                bigMicButton.textContent = 'tap to capture';
            };

            recognition.onerror = function(event) {
                console.log('Speech recognition error:', event.error);
                isListening = false;
                bigMicButton.classList.remove('listening');
                micContainer.classList.remove('listening');
                bigMicButton.textContent = 'tap to capture';
            };

            bigMicButton.addEventListener('click', function() {
                if (isListening) {
                    recognition.stop();
                } else {
                    recognition.start();
                    isListening = true;
                    bigMicButton.classList.add('listening');
                    micContainer.classList.add('listening');
                    bigMicButton.textContent = 'listening...';
                }
            });
        } else {
            bigMicButton.disabled = true;
            bigMicButton.textContent = 'voice not supported';
        }

        // ===== INIT =====
        updateDisplay();

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(function(registration) {
                    console.log('Service Worker registered');
                })
                .catch(function(error) {
                    console.log('Service Worker registration failed:', error);
                });
        }
    </script>
</body>
</html>
